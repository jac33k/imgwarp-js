var ImgWarper=ImgWarper||{};ImgWarper.Point=function(a,b){this.x=a,this.y=b},ImgWarper.Point.prototype.add=function(a){return new ImgWarper.Point(this.x+a.x,this.y+a.y)},ImgWarper.Point.prototype.subtract=function(a){return new ImgWarper.Point(this.x-a.x,this.y-a.y)},ImgWarper.Point.prototype.wXtX=function(a){return new ImgWarper.Matrix22(this.x*this.x*a,this.x*this.y*a,this.y*this.x*a,this.y*this.y*a)},ImgWarper.Point.prototype.dotP=function(a){return this.x*a.x+this.y*a.y},ImgWarper.Point.prototype.multiply=function(a){return new ImgWarper.Point(this.x*a.M11+this.y*a.M21,this.x*a.M12+this.y*a.M22)},ImgWarper.Point.prototype.multiply_d=function(a){return new ImgWarper.Point(this.x*a,this.y*a)},ImgWarper.Point.weightedAverage=function(a,b){var c,d=0,e=0,f=0;for(c=0;c<a.length;c++)d+=a[c].x*b[c],e+=a[c].y*b[c],f+=b[c];return new ImgWarper.Point(d/f,e/f)},ImgWarper.Point.prototype.InfintyNormDistanceTo=function(a){return Math.max(Math.abs(this.x-a.x),Math.abs(this.y-a.y))};var ImgWarper=ImgWarper||{};ImgWarper.Matrix22=function(a,b,c,d){this.M11=a,this.M12=b,this.M21=c,this.M22=d},ImgWarper.Matrix22.prototype.adjugate=function(){return new ImgWarper.Matrix22(this.M22,-this.M12,-this.M21,this.M11)},ImgWarper.Matrix22.prototype.determinant=function(){return this.M11*this.M22-this.M12*this.M21},ImgWarper.Matrix22.prototype.multiply=function(a){return this.M11*=a,this.M12*=a,this.M21*=a,this.M22*=a,this},ImgWarper.Matrix22.prototype.addM=function(a){this.M11+=a.M11,this.M12+=a.M12,this.M21+=a.M21,this.M22+=a.M22},ImgWarper.Matrix22.prototype.inverse=function(){return this.adjugate().multiply(1/this.determinant())};var ImgWarper=ImgWarper||{};ImgWarper.Warper=function(e,f,g,h,i){this.alpha=i||1,this.gridSize=h||20,this.canvas=e,this.ctx=e.getContext("2d");var j=f;this.width=j.width,this.height=j.height,this.imgData=g.data,e.width=j.width,e.height=j.height,this.bilinearInterpolation=new ImgWarper.BilinearInterpolation(this.width,this.height,e),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.putImageData(g,0,0),console.log("drawn"),this.grid=[];for(var k=0;k<this.width;k+=this.gridSize)for(var l=0;l<this.height;l+=this.gridSize)a=new ImgWarper.Point(k,l),b=new ImgWarper.Point(k+this.gridSize,l),c=new ImgWarper.Point(k+this.gridSize,l+this.gridSize),d=new ImgWarper.Point(k,l+this.gridSize),this.grid.push([a,b,c,d])},ImgWarper.Warper.prototype.warp=function(a,b){for(var c=((new Date).getTime(),new ImgWarper.AffineDeformation(b,a,this.alpha)),d=[],e=0;e<this.grid.length;++e)d[e]=[c.pointMover(this.grid[e][0]),c.pointMover(this.grid[e][1]),c.pointMover(this.grid[e][2]),c.pointMover(this.grid[e][3])];var f=((new Date).getTime(),this.bilinearInterpolation.generate(this.imgData,this.grid,d));this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.putImageData(f,0,0);(new Date).getTime()},ImgWarper.Warper.prototype.drawGrid=function(a,b){for(var c=new ImgWarper.AffineDeformation(a,b,this.alpha),d=this.canvas.getContext("2d"),e=0;e<this.grid.length;++e){d.beginPath();var f=c.pointMover(this.grid[e][0]);d.moveTo(f.x,f.y);for(var g=1;4>g;++g)f=c.pointMover(this.grid[e][g]),d.lineTo(f.x,f.y);d.strokeStyle="rgba(170, 170, 170, 0.5)",d.stroke()}},ImgWarper.AffineDeformation=function(a,b,c){return this.w=null,this.pRelative=null,this.qRelative=null,this.A=null,a.length!=b.length?void console.error("Points are not of same length."):(this.n=a.length,this.fromPoints=a,this.toPoints=b,void(this.alpha=c))},ImgWarper.AffineDeformation.prototype.pointMover=function(a){(null==this.pRelative||this.pRelative.length<this.n)&&(this.pRelative=new Array(this.n)),(null==this.qRelative||this.qRelative.length<this.n)&&(this.qRelative=new Array(this.n)),(null==this.w||this.w.length<this.n)&&(this.w=new Array(this.n)),(null==this.A||this.A.length<this.n)&&(this.A=new Array(this.n));for(var b=0;b<this.n;++b){var c=this.fromPoints[b].subtract(a);this.w[b]=Math.pow(c.x*c.x+c.y*c.y,-this.alpha)}for(var d=ImgWarper.Point.weightedAverage(this.fromPoints,this.w),e=ImgWarper.Point.weightedAverage(this.toPoints,this.w),b=0;b<this.n;++b)this.pRelative[b]=this.fromPoints[b].subtract(d),this.qRelative[b]=this.toPoints[b].subtract(e);for(var f=new ImgWarper.Matrix22(0,0,0,0),b=0;b<this.n;++b)f.addM(this.pRelative[b].wXtX(this.w[b]));f=f.inverse();for(var g=0;g<this.n;++g)this.A[g]=a.subtract(d).multiply(f).dotP(this.pRelative[g])*this.w[g];for(var h=e,g=0;g<this.n;++g)h=h.add(this.qRelative[g].multiply_d(this.A[g]));return h};var ImgWarper=ImgWarper||{};ImgWarper.BilinearInterpolation=function(a,b,c){this.width=a,this.height=b,this.ctx=c.getContext("2d"),this.imgTargetData=this.ctx.createImageData(this.width,this.height)},ImgWarper.BilinearInterpolation.prototype.generate=function(a,b,c){this.imgData=a;for(var d=0;d<c.length;++d)this.fill(c[d],b[d]);return this.imgTargetData},ImgWarper.BilinearInterpolation.prototype.fill=function(a,b){var c,d,e,f,g=b[0].x,h=b[2].x,i=b[0].y,j=b[2].y;g=Math.max(g,0),i=Math.max(i,0),h=Math.min(h,this.width-1),j=Math.min(j,this.height-1);var k,l,m,n,o,p,q,r,s;for(c=g;h>=c;++c)for(k=(c-g)/(h-g),l=1-k,m=l*a[0].x+k*a[1].x,n=l*a[0].y+k*a[1].y,o=l*a[3].x+k*a[2].x,p=l*a[3].y+k*a[2].y,d=i;j>=d;++d)if(q=(d-i)/(j-i),r=1-q,e=m*r+o*q,f=n*r+p*q,s=4*(d*this.width+c),0>e||e>this.width-1||0>f||f>this.height-1)this.imgTargetData.data[s]=255,this.imgTargetData.data[s+1]=255,this.imgTargetData.data[s+2]=255,this.imgTargetData.data[s+3]=255;else{var t=Math.floor(e),u=Math.floor(f),v=4*(u*this.width+t);this.imgTargetData.data[s]=this.imgData[v],this.imgTargetData.data[s+1]=this.imgData[v+1],this.imgTargetData.data[s+2]=this.imgData[v+2],this.imgTargetData.data[s+3]=this.imgData[v+3]}},ImgWarper.BilinearInterpolation.prototype.nnquery=function(a,b){var c=Math.floor(a),d=Math.floor(b),e=4*(d*this.width+c);return[this.imgData[e],this.imgData[e+1],this.imgData[e+2],this.imgData[e+3]]},ImgWarper.BilinearInterpolation.prototype.query=function(a,b){var c,d,e,f;c=Math.floor(a),d=Math.ceil(a),e=Math.floor(b),f=Math.ceil(b);for(var g=[0,0,0,0],h=4*(e*this.width+c),i=4*(f*this.width+c),j=4*(e*this.width+d),k=4*(f*this.width+d),l=0;4>l;++l)t11=this.imgData[h+l],t12=this.imgData[i+l],t21=this.imgData[j+l],t22=this.imgData[k+l],t=(t11*(d-a)*(f-b)+t21*(a-c)*(f-b)+t12*(d-a)*(b-e)+t22*(a-c)*(b-e))/((d-c)*(f-e)),g[l]=parseInt(t);return g};var ImgWarper=ImgWarper||{};ImgWarper.PointDefiner=function(a,b,c){this.oriPoints=new Array,this.dstPoints=new Array;var d=a;this.canvas=a;this.currentPointIndex=-1,this.imgWarper=new ImgWarper.Warper(d,b,c)},ImgWarper.PointDefiner.prototype.redraw=function(){this.imgWarper.warp(this.oriPoints,this.dstPoints)},ImgWarper.PointDefiner.prototype.getCurrentPointIndex=function(a){for(var b=-1,c=0;c<this.dstPoints.length;c++)if(this.dstPoints[c].InfintyNormDistanceTo(a)<=20)return b=c,c;return b};